<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Database</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-keyword">import</span><span> </span><a href="DownloadMovies.html"><span class="hs-identifier">DownloadMovies</span></a><span>
</span><a name="line-4"></a><span class="hs-keyword">import</span><span> </span><a href="MovieDataType.html"><span class="hs-identifier">MovieDataType</span></a><span>
</span><a name="line-5"></a><span class="hs-keyword">import</span><span> </span><a href="ParseResponse.html"><span class="hs-identifier">ParseResponse</span></a><span>
</span><a name="line-6"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC</span><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database.HDBC.Sqlite3</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.List</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Exception</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-comment">-- | The below functions are used for establishing a connection to the database</span><span>
</span><a name="line-12"></a><span class="hs-identifier">dbConnect</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Connection</span><span>
</span><a name="line-13"></a><a name="dbConnect"><a href="Database.html#dbConnect"><span class="hs-identifier">dbConnect</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">connectSqlite3</span><span> </span><span class="hs-string">&quot;DB.db&quot;</span><span>
</span><a name="line-14"></a><span>
</span><a name="line-15"></a><span class="hs-identifier">r</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Connection</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679087180"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679087180"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-16"></a><a name="r"><a href="Database.html#r"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bracket</span><span> </span><a href="Database.html#dbConnect"><span class="hs-identifier hs-var">dbConnect</span></a><span> </span><span class="hs-identifier hs-var">disconnect</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-comment">-- | setupDatabase initialises the database creating tables</span><span>
</span><a name="line-20"></a><span class="hs-identifier">setupDatabase</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-identifier hs-type">Connection</span><span>
</span><a name="line-21"></a><a name="setupDatabase"><a href="Database.html#setupDatabase"><span class="hs-identifier">setupDatabase</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-22"></a><span>   </span><a name="local-6989586621679087636"><a href="#local-6989586621679087636"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.html#dbConnect"><span class="hs-identifier hs-var">dbConnect</span></a><span>
</span><a name="line-23"></a><span>   </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-string">&quot;Connection Successful&quot;</span><span>
</span><a name="line-24"></a><span>   </span><span class="hs-identifier hs-var">run</span><span> </span><a href="#local-6989586621679087636"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-string">&quot;CREATE TABLE IF NOT EXISTS movieTable (\
                \id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,\
                \rank INTEGER NOT NULL UNIQUE ,\
                \name VARCHAR(80) NOT NULL ,\
                \year INTEGER NOT NULL ,\
                \rating REAL NOT NULL,\
                \dirFName VARCHAR(40) NOT NULL,\
                \dirLName VARCHAR(40) NOT NULL)&quot;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-32"></a><span>   </span><span class="hs-identifier hs-var">run</span><span> </span><a href="#local-6989586621679087636"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-string">&quot;CREATE TABLE IF NOT EXISTS starringTable (\
                \id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, \
                \starFName VARCHAR(40) NOT NULL, \
                \starLName VARCHAR(40) NOT NULL)&quot;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-36"></a><span>   </span><span class="hs-identifier hs-var">run</span><span> </span><a href="#local-6989586621679087636"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-string">&quot;CREATE TABLE IF NOT EXISTS movTable_starTable (\
                \movieID INTEGER, \
                \starringID INTEGER, \
                \FOREIGN KEY(movieID) REFERENCES movieTable(id), \
                \FOREIGN KEY(starringID) REFERENCES starringTable(id) )&quot;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-41"></a><span>   </span><span class="hs-identifier hs-var">commit</span><span> </span><a href="#local-6989586621679087636"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span>   </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621679087636"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-44"></a><span class="hs-comment">-- | populateMovies populates movie data into a table of its own.</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- | Begins by preparing Connections</span><span>
</span><a name="line-46"></a><span class="hs-comment">-- | Then inserts and Commit</span><span>
</span><a name="line-47"></a><span class="hs-identifier">populateMovies</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><a name="populateMovies"><a href="Database.html#populateMovies"><span class="hs-identifier">populateMovies</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-49"></a><span>     </span><a name="local-6989586621679087637"><a href="#local-6989586621679087637"><span class="hs-identifier">movieDataset</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DownloadMovies.html#readMovies"><span class="hs-identifier hs-var">readMovies</span></a><span>
</span><a name="line-50"></a><span>     </span><a name="local-6989586621679087638"><a href="#local-6989586621679087638"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Database.html#dbConnect"><span class="hs-identifier hs-var">dbConnect</span></a><span>
</span><a name="line-51"></a><span>     </span><a name="local-6989586621679087639"><a href="#local-6989586621679087639"><span class="hs-identifier">stmt</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679087638"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-string">&quot;INSERT OR IGNORE INTO movieTable(\
                                    \rank,\
                                    \name,\
                                    \year,\
                                    \rating,\
                                    \dirFName,\
                                    \dirLName)\
                                    \VALUES (?,?,?,?,?,?)&quot;</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>     </span><a name="local-6989586621679087640"><a href="#local-6989586621679087640"><span class="hs-identifier">stmt2</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679087638"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-string">&quot;INSERT OR IGNORE INTO starringTable (\
                             \starFName, \
                             \starLName) \
                             \VALUES (?,?)&quot;</span><span>
</span><a name="line-64"></a><span>     </span><a name="local-6989586621679087641"><a href="#local-6989586621679087641"><span class="hs-identifier">stmt3</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">prepare</span><span> </span><a href="#local-6989586621679087638"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-string">&quot;INSERT OR IGNORE INTO movTable_starTable (\
                                \movieID, \
                                \starringID) \
                                \VALUES (?,?)&quot;</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679087642"><a href="#local-6989586621679087642"><span class="hs-identifier">insertMovies</span></a></a><span> </span><a name="local-6989586621679087643"><a href="#local-6989586621679087643"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rank</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679087643"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-70"></a><span>                           </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">name</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679087643"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-71"></a><span>                           </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">year</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span> </span><span class="hs-operator hs-var">!!</span><span class="hs-special">(</span><a href="#local-6989586621679087643"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-72"></a><span>                           </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rating</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span> </span><span class="hs-operator hs-var">!!</span><span class="hs-special">(</span><a href="#local-6989586621679087643"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-73"></a><span>                           </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">director</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span> </span><span class="hs-operator hs-var">!!</span><span class="hs-special">(</span><a href="#local-6989586621679087643"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-74"></a><span>                           </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">director</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span> </span><span class="hs-operator hs-var">!!</span><span class="hs-special">(</span><a href="#local-6989586621679087643"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-75"></a><span>
</span><a name="line-76"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679088298"><a href="#local-6989586621679088298"><span class="hs-identifier">insertActors</span></a></a><span> </span><a name="local-6989586621679088299"><a href="#local-6989586621679088299"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">starring</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span class="hs-operator hs-var">!!</span><span class="hs-special">(</span><a href="#local-6989586621679088299"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><a name="line-77"></a><span>                            </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span>  </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">' '</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">reverse</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">starring</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679087637"><span class="hs-identifier hs-var">movieDataset</span></a><span class="hs-operator hs-var">!!</span><span class="hs-special">(</span><a href="#local-6989586621679088299"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-78"></a><span>
</span><a name="line-79"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679088300"><a href="#local-6989586621679088300"><span class="hs-identifier">insertActorsMovies</span></a></a><span> </span><a name="local-6989586621679088301"><a href="#local-6989586621679088301"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679088301"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toSql</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><a href="#local-6989586621679088301"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-glyph">::</span><span class="hs-identifier hs-type">Int</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-80"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679088302"><a href="#local-6989586621679088302"><span class="hs-identifier">populateMovieTable</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679087642"><span class="hs-identifier hs-var">insertMovies</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-number">152</span><span class="hs-special">]</span><span>
</span><a name="line-81"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679088303"><a href="#local-6989586621679088303"><span class="hs-identifier">populateActors</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679088298"><span class="hs-identifier hs-var">insertActors</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-number">152</span><span class="hs-special">]</span><span>
</span><a name="line-82"></a><span>     </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679088304"><a href="#local-6989586621679088304"><span class="hs-identifier">populateActorsMovies</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="#local-6989586621679088300"><span class="hs-identifier hs-var">insertActorsMovies</span></a><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-number">152</span><span class="hs-special">]</span><span>
</span><a name="line-83"></a><span>
</span><a name="line-84"></a><span>     </span><span class="hs-identifier">executeMany</span><span> </span><a href="#local-6989586621679087639"><span class="hs-identifier hs-var">stmt</span></a><span> </span><a href="#local-6989586621679088302"><span class="hs-identifier hs-var">populateMovieTable</span></a><span>
</span><a name="line-85"></a><span>     </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-string">&quot;Movies inserted successfully&quot;</span><span>
</span><a name="line-86"></a><span>     </span><span class="hs-identifier hs-var">commit</span><span> </span><a href="#local-6989586621679087638"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-87"></a><span>     </span><span class="hs-identifier">executeMany</span><span> </span><a href="#local-6989586621679087640"><span class="hs-identifier hs-var">stmt2</span></a><span> </span><a href="#local-6989586621679088303"><span class="hs-identifier hs-var">populateActors</span></a><span>
</span><a name="line-88"></a><span>     </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-string">&quot;Stars inserted successfully&quot;</span><span>
</span><a name="line-89"></a><span>     </span><span class="hs-identifier hs-var">commit</span><span> </span><a href="#local-6989586621679087638"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-90"></a><span>     </span><span class="hs-identifier">executeMany</span><span> </span><a href="#local-6989586621679087641"><span class="hs-identifier hs-var">stmt3</span></a><span> </span><a href="#local-6989586621679088304"><span class="hs-identifier hs-var">populateActorsMovies</span></a><span>
</span><a name="line-91"></a><span>     </span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-string">&quot;All Successful&quot;</span><span>
</span><a name="line-92"></a><span>     </span><span class="hs-identifier hs-var">commit</span><span> </span><a href="#local-6989586621679087638"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-93"></a></pre></body></html>